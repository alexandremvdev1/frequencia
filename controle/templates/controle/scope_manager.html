{% load static %}
<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Gestão de Acessos • Scopes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  <style>
    :root{ --ink:#0f172a; --muted:#64748b; --g1:#0b1020; --g2:#111a3a; --base-font:14px; }
    html{ font-size: var(--base-font); }
    body{ background:#f6f8fb; color:var(--ink); }
    .nav-pro{ background:linear-gradient(90deg,var(--g1),var(--g2)); }
    .welcome{ background:linear-gradient(90deg,#111827,#1f2937); color:#fff; border-radius:.75rem; padding:1rem 1.25rem; box-shadow:0 10px 24px rgba(17,24,39,.12); }
    .card-clean{ border:none; box-shadow:0 10px 24px rgba(17,24,39,.08); border-radius:.9rem; }
    .text-muted-2{ color:var(--muted); }
    .banner-desenvolvido{ background:linear-gradient(90deg,#2a4d69,#3b82f6); color:#fff; font-size:.8rem; }
    .pill{ font-size:.75rem; padding:.15rem .45rem; border-radius:999px; border:1px solid #e5e7eb; background:#fff; }
  </style>
</head>
<body>
<nav class="navbar nav-pro navbar-dark mb-3">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="{% url 'controle:painel_controle' %}"><i class="fa-solid fa-user-shield me-1"></i> Gestão de Acessos</a>
    <div class="ms-auto d-flex gap-2">
      <a class="btn btn-sm btn-outline-light" href="{% url 'controle:scope_debug' %}">Debug</a>
      <a class="btn btn-sm btn-outline-light" href="{% url 'controle:painel_controle' %}">← Painel</a>
      <a class="btn btn-sm btn-danger" href="{% url 'controle:logout' %}"><i class="fa-solid fa-right-from-bracket me-1"></i> Sair</a>
    </div>
  </div>
</nav>

<main class="container py-2 py-lg-3">
  {% if messages %}
    <div class="mb-3">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags|default:'info' }} mb-2">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="welcome mb-3">
    <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2">
      <div>
        <div class="h6 m-0">Gerenciar escopos de acesso</div>
        <div class="small" style="opacity:.85">Apenas superadmin. Adicione ou remova escopos para qualquer usuário.</div>
      </div>
      <div>
        <span class="badge text-bg-light">Total de escopos: {{ scopes|length }}</span>
      </div>
    </div>
  </div>

  <!-- Form: adicionar escopo -->
  <form method="post" class="card card-clean p-3 mb-3" novalidate>
    {% csrf_token %}
    <input type="hidden" name="action" value="add">
    <h2 class="h6 m-0 mb-3"><i class="fa-solid fa-plus me-1"></i> Adicionar escopo</h2>

    <div class="row g-3">
      <div class="col-12 col-md-4">
        <label class="form-label">Usuário</label>
        <select class="form-select" name="user_id" required>
          <option value="">— selecione —</option>
          {% for u in users %}
            <option value="{{ u.id }}" {% if request.POST.user_id|default:'' == u.id|stringformat:'s' %}selected{% endif %}>
              {{ u.get_full_name|default:u.username }} ({{ u.username }})
            </option>
          {% empty %}
            <option value="" disabled>Sem usuários</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-6 col-md-3">
        <label class="form-label">Nível</label>
        <select class="form-select" name="nivel" required>
          <option value="LEITURA"  {% if request.POST.nivel == 'LEITURA' %}selected{% endif %}>Leitura</option>
          <option value="GERENCIA" {% if request.POST.nivel == 'GERENCIA' %}selected{% endif %}>Gerência (CRUD)</option>
        </select>
      </div>

      <div class="col-6 col-md-5">
        <label class="form-label">Tipo de alvo</label>
        <select class="form-select" id="id_alvo_tipo" name="alvo_tipo" required>
          {% with at=request.POST.alvo_tipo|default:'' %}
            <option value="">— selecione —</option>
            <option value="prefeitura"  {% if at == 'prefeitura' %}selected{% endif %}>Prefeitura</option>
            <option value="secretaria"  {% if at == 'secretaria' %}selected{% endif %}>Secretaria</option>
            <option value="escola"      {% if at == 'escola' %}selected{% endif %}>Escola</option>
            <option value="departamento"{% if at == 'departamento' %}selected{% endif %}>Departamento</option>
            <option value="setor"       {% if at == 'setor' %}selected{% endif %}>Setor</option>
          {% endwith %}
        </select>
      </div>
    </div>

    <div class="row g-3 mt-1">
      <div class="col-12 col-md-6 alvo-target" data-target="prefeitura" style="display:none">
        <label class="form-label">Prefeitura</label>
        <select class="form-select" data-source name="alvo_id">
          {% for p in prefeituras %}
            <option value="{{ p.id }}" {% if request.POST.alvo_id|default:'' == p.id|stringformat:'s' %}selected{% endif %}>{{ p.nome }}</option>
          {% empty %}
            <option value="" disabled>Sem prefeituras</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-12 col-md-6 alvo-target" data-target="secretaria" style="display:none">
        <label class="form-label">Secretaria</label>
        <select class="form-select" data-source name="alvo_id">
          {% for s in secretarias %}
            <option value="{{ s.id }}" {% if request.POST.alvo_id|default:'' == s.id|stringformat:'s' %}selected{% endif %}>
              {{ s.prefeitura.nome }} — {{ s.nome }}
            </option>
          {% empty %}
            <option value="" disabled>Sem secretarias</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-12 col-md-6 alvo-target" data-target="escola" style="display:none">
        <label class="form-label">Escola</label>
        <select class="form-select" data-source name="alvo_id">
          {% for e in escolas %}
            <option value="{{ e.id }}" {% if request.POST.alvo_id|default:'' == e.id|stringformat:'s' %}selected{% endif %}>
              {{ e.secretaria.prefeitura.nome }} — {{ e.secretaria.nome }} — {{ e.nome_escola }}
            </option>
          {% empty %}
            <option value="" disabled>Sem escolas</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-12 col-md-6 alvo-target" data-target="departamento" style="display:none">
        <label class="form-label">Departamento</label>
        <select class="form-select" data-source name="alvo_id">
          {% for d in departamentos %}
            <option value="{{ d.id }}" {% if request.POST.alvo_id|default:'' == d.id|stringformat:'s' %}selected{% endif %}>
              {% if d.prefeitura %}{{ d.prefeitura.nome }} — {% endif %}
              {% if d.secretaria %}{{ d.secretaria.nome }} — {% endif %}
              {% if d.escola %}{{ d.escola.nome_escola }} — {% endif %}
              {{ d.nome }}
            </option>
          {% empty %}
            <option value="" disabled>Sem departamentos</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-12 col-md-6 alvo-target" data-target="setor" style="display:none">
        <label class="form-label">Setor</label>
        <select class="form-select" data-source name="alvo_id">
          {% for st in setores %}
            <option value="{{ st.id }}" {% if request.POST.alvo_id|default:'' == st.id|stringformat:'s' %}selected{% endif %}>
              {% if st.departamento %}
                {% if st.departamento.prefeitura %}{{ st.departamento.prefeitura.nome }} — {% endif %}
                {% if st.departamento.secretaria %}{{ st.departamento.secretaria.nome }} — {% endif %}
                {% if st.departamento.escola %}{{ st.departamento.escola.nome_escola }} — {% endif %}
              {% elif st.secretaria %}
                {{ st.secretaria.prefeitura.nome }} — {{ st.secretaria.nome }} — 
              {% endif %}
              {{ st.nome }}
            </option>
          {% empty %}
            <option value="" disabled>Sem setores</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <div class="mt-3 d-grid d-md-flex gap-2">
      <button class="btn btn-primary" type="submit"><i class="fa-solid fa-plus me-1"></i> Adicionar</button>
      <a class="btn btn-outline-secondary" href="{% url 'controle:painel_controle' %}">Cancelar</a>
    </div>
  </form>

  <!-- Lista de escopos -->
  <div class="card card-clean p-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h6 m-0"><i class="fa-solid fa-list-check me-1"></i> Escopos existentes</h2>
      <a class="btn btn-sm btn-outline-dark" href="{% url 'controle:acessos_revogar' %}">
        <i class="fa-solid fa-trash-can me-1"></i> Revogar
      </a>
    </div>

    {% if scopes %}
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Usuário</th>
              <th>Escopo</th>
              <th>Unidade</th>
              <th>Nível</th>
              <th class="text-end">Ação</th>
            </tr>
          </thead>
          <tbody>
            {% for s in scopes %}
              <tr>
                <td>
                  <div class="fw-semibold">{{ s.user.get_full_name|default:s.user.username }}</div>
                  <div class="text-muted-2 small">{{ s.user.username }}</div>
                </td>
                <td>
                  {% if s.prefeitura %}<span class="pill">Prefeitura</span>
                  {% elif s.secretaria %}<span class="pill">Secretaria</span>
                  {% elif s.escola %}<span class="pill">Escola</span>
                  {% elif s.departamento %}<span class="pill">Departamento</span>
                  {% elif s.setor %}<span class="pill">Setor</span>
                  {% else %}—{% endif %}
                </td>
                <td>
                  {% if s.prefeitura %}
                    {{ s.prefeitura.nome }}
                  {% elif s.secretaria %}
                    {{ s.secretaria.prefeitura.nome }} — {{ s.secretaria.nome }}
                  {% elif s.escola %}
                    {{ s.escola.secretaria.prefeitura.nome }} — {{ s.escola.secretaria.nome }} — {{ s.escola.nome_escola }}
                  {% elif s.departamento %}
                    {% if s.departamento.prefeitura %}{{ s.departamento.prefeitura.nome }} — {% endif %}
                    {% if s.departamento.secretaria %}{{ s.departamento.secretaria.nome }} — {% endif %}
                    {% if s.departamento.escola %}{{ s.departamento.escola.nome_escola }} — {% endif %}
                    {{ s.departamento.nome }}
                  {% elif s.setor %}
                    {% if s.setor.departamento %}
                      {% if s.setor.departamento.prefeitura %}{{ s.setor.departamento.prefeitura.nome }} — {% endif %}
                      {% if s.setor.departamento.secretaria %}{{ s.setor.departamento.secretaria.nome }} — {% endif %}
                      {% if s.setor.departamento.escola %}{{ s.setor.departamento.escola.nome_escola }} — {% endif %}
                    {% elif s.setor.secretaria %}
                      {{ s.setor.secretaria.prefeitura.nome }} — {{ s.setor.secretaria.nome }} — 
                    {% endif %}
                    {{ s.setor.nome }}
                  {% else %}—{% endif %}
                </td>
                <td>{{ s.get_nivel_display|default:s.nivel }}</td>
                <td class="text-end">
                  <form method="post" class="d-inline-block" onsubmit="return confirm('Remover este escopo?');">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="delete">
                    <input type="hidden" name="scope_id" value="{{ s.id }}">
                    <button class="btn btn-sm btn-outline-danger"><i class="fa-solid fa-xmark me-1"></i> Remover</button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-center text-muted-2 py-3">Nenhum escopo cadastrado.</div>
    {% endif %}
  </div>

  <div class="text-center my-4">
    <a class="btn btn-outline-secondary" href="{% url 'controle:painel_controle' %}">
      <i class="fa-solid fa-arrow-left me-1"></i> Voltar ao painel
    </a>
  </div>
</main>

<div class="banner-desenvolvido text-center py-2">
  Desenvolvido por Alexandre Martins Vieira © 2025
</div>

<script>
(function(){
  const tipo = document.getElementById("id_alvo_tipo");
  const targets = document.querySelectorAll(".alvo-target");
  function refresh(){
    const v = (tipo && tipo.value) || "";
    targets.forEach(el => el.style.display = (el.dataset.target === v) ? "block" : "none");
    // Ajusta o name="alvo_id" para somente o select visível
    const selects = document.querySelectorAll('.alvo-target select[data-source]');
    selects.forEach(s => s.name = "");
    const vis = document.querySelector('.alvo-target[data-target="'+v+'"] select[data-source]');
    if (vis) vis.name = "alvo_id";
  }
  if (tipo){
    tipo.addEventListener("change", refresh);
    refresh(); // refletir POST anterior (se houver)
  }
})();
</script>
</body>
</html>
